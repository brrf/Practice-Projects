<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<title>Todo Appsss</title>
	</head>
	<style>
		.hidden {
			display: none;
		}
		ul {
			list-style: none;
		}
	</style>
	<body>
		<form id="form">
			<input type="text" name="description" id="description" />
			<input type="submit" value="Create" />
		</form>
		<p class="hidden">An error occurred</p>
		<ul id="todos">
			{% for d in data %}
			<li>
				<input
					type="checkbox"
					class="check-completed"
					data-id="{{ d.id }}"
					{%
					if
					d.completed
					%}
					checked
					{%
					endif
					%}
				/>{{d.description}}
			</li>
			{% endfor %}
		</ul>
	</body>

	<script>
		const checkboxes = document.querySelectorAll('.check-completed');
		checkboxes.forEach(checkbox => {
			checkbox.addEventListener('change', toggleCompleted);
		});

		function toggleCompleted(e) {
			const todoId = e.target.dataset.id;
			console.log(todoId);
			fetch('/todos/' + todoId + '/togglecompleted', {
				method: 'POST',
				body: JSON.stringify({
					completed: e.target.checked,
				}),
				headers: {
					'Content-Type': 'application/json',
				},
			})
			.then(() => document.querySelector('.hidden').className = 'hidden')
			.catch(() => (document.querySelector('.hidden').className = '')
			);
		}

		document.getElementById('form').onsubmit = function (e) {
			e.preventDefault();

			fetch('/todos/create', {
				method: 'POST',
				body: JSON.stringify({
					description: document.getElementById('description').value,
				}),
				headers: {
					'Content-Type': 'application/json',
				},
			})
				.then(res => res.json())
				.then(jsonResponse => {
					const newLi = document.createElement('li');
					newLi.innerHTML = jsonResponse['description'];
					document.getElementById('todos').appendChild(newLi);
					document.querySelector('.hidden').className = 'hidden';
				})
				.catch(
					() => (document.querySelector('.hidden').className = '')
				);
		};
	</script>
</html>
