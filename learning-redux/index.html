<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>ToDos/Goals</title>
</head>
<body>

	<div>
		<h1>To-dos</h1>
		<input id="todo" type="text" placeholder="Add todo">
		<button id="todoBtn">Add</button>
		<ul id="todos"></ul>
	</div>

	<div>
		<h1>Goals</h1>
		<input id="goal" type="text" placeholder="Add goal">
		<button id="goalBtn">Goal</button>
		<ul id="goals"></ul>
	</div>

	<hr />

	<div id='app'></div>

	
	<script src='https://unpkg.com/react@16.8.3/umd/react.development.js'></script>
	<script src='https://unpkg.com/react-dom@16.8.3/umd/react-dom.development.js'></script>
	<script src='https://unpkg.com/babel-standalone@6.15.0/babel.min.js'></script>
	<script src='https://cdnjs.cloudflare.com/ajax/libs/redux/3.7.2/redux.min.js'></script>

	<script type='text/javascript'>


//generate unique ID for actions
function generateId () {
  return Math.random().toString(36).substring(2) + (new Date()).getTime().toString(36);
}

//reducers
function todos (state = [], action) {
	switch (action.type) {
		case 'ADD_TODO' :
			return state.concat([action.todo]);
		case 'REMOVE_TODO' :
			return state.filter( todo => todo.index !== action.index );	
		case 'TOGGLE_TODO' :
			return state.map( todo => todo.index !== action.index ? todo : 
				Object.assign({}, todo, {completed: !todo.completed})
			)
		default: return state
	}
}

function goals (state = [], action) {
	switch (action.type) {
		case 'ADD_GOAL' :
			return state.concat([action.goal]);
		case 'REMOVE_GOAL' :
			return state.filter( goal => goal.index !== action.index);
		default: return state
	}
}

//Action functions

function addTodoAction (todo) {
	return {
		type: 'ADD_TODO',
		todo
	}
}

function removeTodoAction (index) {
	return {
		type: 'REMOVE_TODO',
		index
	}
}

function toggleTodoAction (index) {
	return {
		type: 'TOGGLE_TODO',
		index
	}
}

function addGoalAction (goal) {
	return {
		type: 'ADD_GOAL',
		goal
	}
}

function removeGoalAction (index) {
	return {
		type: 'REMOVE_GOAL',
		index
	}
}

//middleware

const checker = (store) => (next) => (action) => {
	if (action.type === "ADD_TODO" &&
		action.todo.name.toLowerCase().indexOf('tron') !== -1
	) {
		alert('That is a terrible idea');
	}
	if (action.type === "ADD_GOAL" &&
		action.goal.name.toLowerCase().indexOf('tron') !== -1
	) {
		alert('That is a terrible idea');
	}
	return next(action)
}

const logger = (store) => (next) => (action) => {
	console.group(action.type)
	console.log('The action: ', action);
	const result = next(action);
	console.log('The new state: ', store.getState())
	console.groupEnd()

	return result;
}

//initiate store
const store = Redux.createStore(Redux.combineReducers({
	todos,
	goals
}), Redux.applyMiddleware(checker, logger));

//Update DOM with state

function createRemoveButton (removeItemFunc) {
	const removeBtn = document.createElement('button');
	removeBtn.innerHTML = 'X';
	removeBtn.addEventListener('click', removeItemFunc);

	return removeBtn;
}

const unsubscribe = store.subscribe ( () => {
	const {todos, goals} = store.getState();

	document.getElementById('todos').innerHTML = '';
	document.getElementById('goals').innerHTML = ''
	
	todos.forEach(addTodoToDOM)
	goals.forEach(addGoalToDOM)
});

function addTodoToDOM(todo) {
	const newLi = document.createElement('LI');
	const LiText = todo.name;	
	newLi.innerHTML = LiText;


	const removeButton = createRemoveButton ( () => {
		store.dispatch(removeTodoAction(todo.index))
	})

	newLi.appendChild(removeButton);

	newLi.style.textDecoration = todo.completed ? 'line-through' : 'none'
	newLi.addEventListener('click', () => {
		store.dispatch(toggleTodoAction(todo.index))
		});

	document.getElementById('todos')
		.appendChild(newLi);
}

function addGoalToDOM(goal) {
	const newLi = document.createElement('LI');
	const LiText = goal.name;	
	newLi.innerHTML = LiText;

	const removeButton = createRemoveButton ( () => {
		store.dispatch(removeGoalAction(goal.index))
	})

	newLi.appendChild(removeButton);

	const goals = document.getElementById('goals')
		.appendChild(newLi);
}

function addToDo () {
	const input = document.getElementById('todo');
	const todo = input.value;
	
	input.value = '';

	store.dispatch(addTodoAction({
		index: generateId(),
		name: todo,
		completed: false
	}));
}

function addGoal () {
	const input = document.getElementById('goal');
	const goal = input.value;
	input.value = '';

	store.dispatch(addGoalAction({
		index: generateId(),
		name: goal,
		completed: false
	}));
}

document.getElementById('todoBtn').
	addEventListener('click', addToDo)

document.getElementById('goalBtn').
	addEventListener('click', addGoal)

</script>

	<script type='text/babel'> 


		function List (props) {

			return (
				<ul>
					{props.items.map( item => (
						<li key={item.index}>
							<span onClick={ () => props.toggleItem && props.toggleItem(item)}
								  style={item.completed ? {textDecoration: 'line-through'} : {textDecoration: 'none'}} >
								{item.name}
							</span>
							<button onClick={ () => props.removeItem(item)}>X</button>
						</li>

					))}
				</ul>
			)
		}



		class Todos extends React.Component {

			addItem = (e) => {
				e.preventDefault();
				const name = this.input.value;
				this.input.value = '';

				this.props.store.dispatch(addTodoAction({
					index: generateId(),
					name,
					completed: false
				}))

			}

			removeItem = item => {
				this.props.store.dispatch(removeTodoAction(item.index));
			}

			toggleItem = item => {
				this.props.store.dispatch(toggleTodoAction(item.index))
			}

			render () {
				return (
					<div>
						<h1>Todos</h1>
						<input 
							placeholder='Add Todo'
							type='text'
							ref={(input) => this.input = input}
						/>
						<button onClick={this.addItem}>
							Add ToDo
						</button>
						<List items={this.props.todos}
							  removeItem = {this.removeItem}
							  toggleItem={this.toggleItem}/>
					</div>
				)
			}
		}

		class Goals extends React.Component {

			addItem = (e) => {
				e.preventDefault();
				const name = this.input.value;
				this.input.value = '';

				this.props.store.dispatch(addGoalAction({
					index: generateId(),
					name,
				}))
			}

			removeItem = item => {
				this.props.store.dispatch(removeGoalAction(item.index));
			}

			render () {
				return (
					<div>
						<h1>Goals</h1>
						<input 
							placeholder='Add Goal'
							type='text'
							ref={(input) => this.input = input}
						/>
						<button onClick={this.addItem}>
							Add Goal
						</button>
						<List items={this.props.goals}
							  removeItem={this.removeItem}/>
					</div>
				)
			}
		}

		class App extends React.Component {

			componentDidMount () {

				const {store} = this.props

				store.subscribe( () => this.forceUpdate() )
			}

			render() {

				const {todos, goals} = this.props.store.getState()
				return (
					<div>
						<Todos todos={todos} store={this.props.store}/>
						<Goals goals={goals} store={this.props.store}/>
					</div>
				)
			}
		}


	ReactDOM.render(
		<App store={store}/>, 
		document.getElementById('app')
	);

	</script>




</body>
</html>